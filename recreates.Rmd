---
title: "Recreating figures from Storytelling with Data"
author: "Ashleigh Wilson"
date: '2022-02-24'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(readxl)
library(janitor)
library(scales)
library(lemon)
library(ggtext)
library(grid)
library(gridExtra)
library(gridtext)

source("themes/my_swd_theme.R")
```

Reading in excel spreadsheet. Use the range argument to specify the exact cells to import.

```{r}
# meh, don't want to do this graph again.

# data_2_8_og <- read_excel("data/2.8_EXERCISE.xlsx", range = "B5:F15")
# data_2_8 <- clean_names(data_2_8_og)

# data_2_8[10,1] <- "Dec-19" # just changing value name
# data_2_8 <- data_2_8 %>% 
#   rename(year = x1) %>% 
#   mutate(year = as_factor(year))
```

------------------------------------------------------------------------

## Chapter 2 Figures

### 2.7

```{r}
data_0207_OG <- read_csv("data/fig_0207_data.csv")
```

```{r}
data_0207 <- clean_names(data_0207_OG)
```

Graph:

```{r}
data_0207 <- data_0207 %>% 
  mutate(
    cost_per_mile = parse_number(cost_per_mile), # need to convert chars with dollar sign $ by using parse_number()
    avg_miles = mean(miles_driven),
    avg_cost = mean(cost_per_mile),
    color = if_else(cost_per_mile < avg_cost, SILVER, DARKORANGE)
    ) 

avg_miles2 <- mean(data_0207$miles_driven)
avg_cost2 <- mean(data_0207$cost_per_mile)

ggplot(data_0207) +
  geom_point(aes(miles_driven, cost_per_mile, color = color), size = 2) +
  scale_color_identity() + # can use when data has column values that represents aesthetics (which it does with the color column values)
  scale_y_continuous(breaks = seq(0, 3, .5), limits = c(0, 3), labels = scales::dollar_format()) +
  scale_x_continuous(limits = c(0, 4000), labels = scales::label_comma()) + # original was 1000 to 3000. Changing it also shrinks the plot area
  geom_hline(yintercept = avg_cost2, linetype = "longdash") +
  geom_point(aes(avg_miles2, avg_cost2), size = 4) +
  geom_label(aes(avg_miles2, avg_cost2), label = "AVG", hjust = 1.25, size = 4.5, label.size = 0) +
  labs(
    title = "Cost per mile by miles driven",
    y = "Cost per mile",
    x = "Miles driven per month"
  ) +
  my_swd_theme() +
  coord_capped_cart(bottom = "right", left = "top") # this function won't work unless the theme I use has panel.border = element_blank() and axis.line = element_line()
```

### 2.11

```{r}
data_0211_OG <- read_csv("data/fig_0211_data.csv")
```

```{r}
data_0211_1 <- data_0211_OG %>% 
  rename(survey_category = ...1) %>% 
  pivot_longer(cols = c("2014","2015"), names_to = "year", values_to = "percent") %>% 
  mutate(
    percent = parse_number(percent),
    # Relevel the categories to ensure that "Career development" is drawn last and displays on top of the other categories
    survey_category = fct_relevel(factor(survey_category), "Peers", "Culture", "Work environment", "Leadership", "Rewards & recognition", "Perf management", "Career development"),
    color = if_else(survey_category == "Career development", TOMATO, DIMGRAY)
    )

# below code won't work to make the graph
data_0211_2 <- data_0211_OG %>% 
  rename(survey_category = ...1) %>% 
  mutate(
    `2014` = parse_number(`2014`),
    `2015` = parse_number(`2015`)
    )
```

```{r}
ggplot(data_0211_1) +
  # must make survey_category a factor before I can use as group aes
  geom_line(aes(year, percent, group = survey_category, color = color), size = 1) +
  geom_point(aes(year, percent, color = color), size = 3) +
  scale_color_identity() + # always need this when I have color column with hex codes
  scale_x_discrete(expand = expansion(1.9, 0), limits = c("2014","2015"), labels = c(2014,2015)) +
  geom_text(aes(year, percent, label = paste0(percent,"%"), color = color), nudge_x = -.2, data = data_0211_1 %>% filter(year == 2014) %>% filter(survey_category != "Career development")) +
  geom_text(aes(year, percent, label = paste0(percent, "%"), color = color), nudge_x = .2, data = data_0211_1 %>% filter(year == 2015) %>% filter(survey_category != "Career development")) +
  geom_text(aes(year, percent, label = survey_category, color = color), nudge_x = -.4, data = data_0211_1 %>% filter(year == 2014) %>% filter(survey_category != "Career development"), hjust = 1) +
  geom_text(aes(year, percent, label = paste0(percent,"%"), fontface = "bold", color = color), nudge_x = -.2, data = data_0211_1 %>% filter(year == 2014) %>% filter(survey_category == "Career development")) + 
  geom_text(aes(year, percent, label = paste0(percent, "%"), fontface = "bold", color = color), nudge_x = .2, data = data_0211_1 %>% filter(year == 2015) %>% filter(survey_category == "Career development")) +
  geom_text(aes(year, percent, label = survey_category, color = color), fontface = "bold", nudge_x = -.4, data = data_0211_1 %>% filter(year == 2014) %>% filter(survey_category == "Career development"), hjust = 1) +
  my_swd_theme() + theme(
    axis.line.y = element_blank(),
    axis.line.x = element_line(size = .1),
    axis.text.y = element_blank(),
    axis.title.x = element_text(hjust = .5),
    axis.title.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.ticks.x = element_line(color = LIGHTGRAY),
    plot.title = element_text(hjust = .1, vjust = -4),
    plot.subtitle = element_text(hjust = .208, vjust = -10, size = 10, color = DIMGRAY),
  ) +
  labs(
    title = "Employee feedback over time",
    subtitle = "Survey category | Percent favorable",
    x = "survey year"
  ) +
  coord_capped_cart(bottom = "both") # makes the x axis line only connect from 2014 - 2015
```

### 2.19

```{r}
data_0219_OG <- read_csv("data/fig_0219_data.csv")
```

```{r}
data_0219 <- data_0219_OG %>% 
  rename(survey_item = ...1) %>% 
  clean_names() %>% 
  pivot_longer(cols = c("strongly_disagree":"strongly_agree"), names_to = "rating", values_to = "percent") %>% 
  mutate(
    total = parse_number(total),
    percent = parse_number(percent),
    rating = fct_relevel(factor(rating), "strongly_disagree", "disagree", "neutral", "agree", "strongly_agree"),
    rating = fct_rev(rating)
  )

color_scale = c(
      "strongly_disagree" = DARKGRAY,
      "disagree" = DARKGRAY,
      "neutral" = LIGHTGRAY,
      "agree" = BLUEGRAY,
      "strongly_agree" = BLUEGRAY
    )

```

```{r}
ggplot(data_0219, aes(x = percent, y = fct_rev(survey_item), fill = rating)) +
  geom_col(color = "white", width = 0.8) +
  scale_fill_manual(values = color_scale, guide = "none") +
  scale_x_continuous(position = "top", labels = scales::label_percent(scale = 1)) +
  my_swd_theme() + theme(
    axis.line.y = element_blank(),
    axis.line.x = element_line(color = DIMGRAY, size = .2),
    axis.title.y = element_blank(),
    axis.title.x = element_text(color = DARKGRAY, size = 10, hjust = .035),
    axis.text.y = element_text(hjust = 6, size = 10),
    axis.ticks.y = element_blank(),
    axis.ticks.x = element_line(size = .2, color = DIMGRAY),
    plot.margin = margin(.2,.2,.2,.2,"cm"),
    plot.title = element_text(hjust = .04, margin = margin(t = 0, r = 0, b = 10, l = 0, unit = "pt")),
    plot.subtitle = element_markdown(hjust = .41, size = 10) # element_markdown is from the ggtext package. Allows me to set markdown text in plot (See subtitle).
  ) +
  labs(
    title = "Survey results",
    subtitle = paste0(
      "<span style='color:", color_scale[1], "'>", "**Strongly Disagree**", "</span>", " | ",
      "<span style='color:", color_scale[2], "'>", "**Disagree**", "</span>", " | ",
      "<span style='color:", color_scale[3], "'>", "**Neutral**", "</span>", " | ",
      "<span style='color:", color_scale[4], "'>", "**Agree**", "</span>", " | ",
      "<span style='color:", color_scale[5], "'>", "**Strongly Agree**", "</span>"
      ),
    x = "Percent of total"
  ) +
  coord_capped_cart(top = "both")
```

### 4.14

```{r}
data_0414_OG <- read_csv("data/fig_0414_data.csv")
```

```{r}
data_0414 <- data_0414_OG %>% 
  rename(ticket_type = ...1) %>% 
  pivot_longer(cols = -ticket_type, names_to = "month", values_to = "amount") %>% 
  mutate(
    ticket_type = as_factor(ticket_type),
    month = as_factor(month)
  )

# the below is a grob object from the grid_text package. This was the only way to add a markdown annotation text box to the graph.
graph_annotation <- grobTree(richtext_grob(
  "<span style='background_color:white'><b>2 employees quit in May.</b> Ticket volume dramatically <br> decreased in the following two months then increased in July. <br> Volume fluctuated in the months following July.</span>", x = .58, y = .93, gp = gpar(col = GRAY, fontsize = 12), box_gp = gpar(col = "white", fill = "white"), padding = margin(.4,0,0,0,"in")
))
```

Graph

```{r}
ggplot(data_0414, aes(x = month, y = amount, group = ticket_type, color = ticket_type)) +
  geom_line(size = 1) +
  geom_point(size = 2.5, data = data_0414 %>% filter(month %in% c("Aug","Sep","Oct","Nov","Dec"))) + # seems I can use data arg in any geom to filter for specific data to be shown
  geom_vline(xintercept = "May", color = GRAY) + # the grob textbox will cover the top part of the vline, giving it that 'cutoff' appearance.
  # geom_linerange(x = "May", ymin = 0, ymax = 240) +
  scale_color_manual(values = c(GRAY, BLUEGRAY)) +
  scale_y_continuous(limits = c(0,300), breaks = seq(0,300,50)) +
  scale_x_discrete(expand = expansion(add = c(.02, 3))) +
  geom_text(aes(label = amount), nudge_y = 18, data = data_0414 %>% filter(ticket_type != "Ticket Volume Processed") %>% filter(month %in% c("Aug","Sep","Oct","Nov","Dec"))) +
  geom_text(aes(label = amount), nudge_y = -18, data = data_0414 %>% filter(ticket_type != "Ticket Volume Received") %>% filter(month %in% c("Aug","Sep","Oct","Nov","Dec"))) +
  annotate("text", x = 13.5, y = 180, size = 5, color = GRAY, label = "bold(Received)", parse = TRUE) +
  annotate("text", x = 13.68, y = 142, size = 5, color = BLUEGRAY, label = "bold(Processed)", parse = TRUE) +
  annotation_custom(graph_annotation) + # used with custom grob
  coord_capped_cart(bottom = "right", left = "top") +
  labs(
    title = "Ticket volume over time"
  ) +
  my_swd_theme() + theme(
    legend.position = "none",
    plot.margin = margin(t = .5, r = .5, b = .5, l = .5, unit = "cm"),
    plot.background = element_rect(color = "white"),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    axis.line = element_line(size = .2),
    axis.ticks.x = element_blank(),
  )
```

### 5.4

```{r}
data_0504_OG <- read_csv("data/fig_0504_data.csv")
```

```{r}
data_0504 <- data_0504_OG %>% 
  pivot_longer(cols = "2008":"2012", names_to = "year", values_to = "number") %>% 
  filter(Category != "All") %>% 
  mutate(
    Category = as_factor(Category),
    color = if_else(Category == "Bachelor's degree or more", ORANGE, SILVER)
    ) 
```

Graph

```{r}
ggplot(data_0504, aes(year, number, group = Category, color = color)) +
  geom_line(size = 1.5) +
  geom_point(size = 3, data = data_0504 %>% filter(year %in% c("2008","2012"))) +
  scale_color_identity() +
  scale_x_discrete(expand = expansion(add = c(5,1))) +
  scale_y_continuous(limits = c(5,65)) + # setting limits can `zoom-in or out` of the plot, so to speak. Gives me more space below the below most line.
  geom_text(aes(label = number), size = 6.5, nudge_x = .3, nudge_y = .4, data = data_0504 %>% filter(year == "2012") %>% mutate(number = round(number))) +
  geom_text(aes(label = number), size = 6.5, nudge_x = -.15, nudge_y = .4, hjust = 1, data = data_0504 %>% filter(year == "2008") %>% mutate(number = round(number))) +
  geom_text(aes(label = Category), size = 6, nudge_x = -.7, nudge_y = .2, hjust = 1, data = data_0504 %>% filter(year == "2008", Category != "Bachelor's degree or more")) + # hjust will line the Categories neatly
  geom_text(aes(label = Category), size = 6, nudge_x = -.7, nudge_y = .4, hjust = 1, data = data_0504 %>% filter(year == "2008", Category == "Bachelor's degree or more")) +
  labs(
    title = "New marriage rate by education",
    subtitle = paste0("<span>Number of <b>newly</b> married adults per 1,000 marriage eligible adults</span>"),
    caption = "Note: Marriage eligibility includes newly married plus those widowed or divorced.\nSource: US Census\nAdapted from PEW RESEARCH CENTER"
  ) +
  coord_capped_cart(bottom = "both") + # I think this needs to always be at the bottom of the ggplot call.
  my_swd_theme() + theme(
    axis.title.y = element_blank(),
    axis.title.x = element_blank(),
    axis.line.y = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    plot.subtitle = element_markdown(size = 10)
  )
```
